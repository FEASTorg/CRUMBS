name: CI

on:
  push:
    branches: [dev, main]
  pull_request:
    branches: [dev, main]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            git \
            pkg-config \
            libi2c-dev \
            libudev-dev \
            python3-pip

      - name: Restore linux-wire cache
        uses: actions/cache@v4
        with:
          path: |
            third_party/linux-wire/build
            third_party/linux-wire/install
          key: ${{ runner.os }}-linux-wire-v1

      - name: Build and install linux-wire
        run: |
          git clone --depth=1 https://github.com/FEASTorg/linux-wire.git third_party/linux-wire
          cmake -S third_party/linux-wire -B third_party/linux-wire/build \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/third_party/linux-wire/install
          cmake --build third_party/linux-wire/build --parallel
          cmake --install third_party/linux-wire/build

      - name: Configure CRUMBS
        env:
          CMAKE_PREFIX_PATH: ${{ github.workspace }}/third_party/linux-wire/install
        run: |
          cmake -S . -B build \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCRUMBS_ENABLE_TESTS=ON \
            -DCRUMBS_ENABLE_LINUX_HAL=ON \
            -DCMAKE_PREFIX_PATH="${CMAKE_PREFIX_PATH}"

      - name: Build CRUMBS
        run: cmake --build build --parallel

      - name: Run CRUMBS tests
        run: ctest --test-dir build --output-on-failure

      - name: Install CRUMBS locally for out-of-tree example test
        run: |
          cmake --install build --prefix ${GITHUB_WORKSPACE}/install

      - name: Show installed crumbs package config
        run: |
          echo "--- installed crumbsConfig.cmake ---"
          sed -n '1,200p' ${GITHUB_WORKSPACE}/install/lib/cmake/crumbs/crumbsConfig.cmake || true
          echo "--- end ---"

      - name: Build native example (out-of-tree) against installed crumbs
        run: |
          # Compute prefixes at runtime using the expanded GITHUB_WORKSPACE
          LINUX_WIRE_PREFIX="${GITHUB_WORKSPACE}/third_party/linux-wire/install"
          INSTALL_PREFIX="${GITHUB_WORKSPACE}/install"
          CMAKE_PREFIX_PATH="${LINUX_WIRE_PREFIX}:${INSTALL_PREFIX}"
          export CMAKE_PREFIX_PATH
          echo "CMAKE_PREFIX_PATH='${CMAKE_PREFIX_PATH}'"
          echo "Listing install tree (top level):"
          ls -la ${GITHUB_WORKSPACE}/install || true
          echo "Listing lib cmake dir (if present):"
          ls -la ${GITHUB_WORKSPACE}/install/lib/cmake || true
          echo "Listing share cmake dir (if present):"
          ls -la ${GITHUB_WORKSPACE}/install/share/cmake || true

          # Verify linux_wire package config exists under the linux-wire install prefix
          LINUX_WIRE_CFG=$(find "${LINUX_WIRE_PREFIX}" -name 'linux_wireConfig.cmake' -print -quit || true)
          if [ -z "${LINUX_WIRE_CFG}" ]; then
            echo "ERROR: linux_wireConfig.cmake not found under ${LINUX_WIRE_PREFIX}.";
            echo "linux-wire install tree:"; find "${LINUX_WIRE_PREFIX}" -maxdepth 5 -type f -print || true;
            echo "You may need to ensure linux-wire was built/installed correctly or add its prefix to CMAKE_PREFIX_PATH.";
            # Continue so we print crumbs state too; but fail later to make logs available
            LINUX_WIRE_CFG=""
          else
            echo "Found linux_wireConfig.cmake at: ${LINUX_WIRE_CFG}"
            LINUX_WIRE_DIR=$(dirname "${LINUX_WIRE_CFG}")
            echo "linux_wire_DIR will be: ${LINUX_WIRE_DIR}"
            export linux_wire_DIR="${LINUX_WIRE_DIR}"
          fi

          # Locate the installed crumbs package config file and point CMake directly at it
          CRUMBS_CFG=$(find ${GITHUB_WORKSPACE}/install -name 'crumbsConfig.cmake' -print -quit || true)
          if [ -z "${CRUMBS_CFG}" ]; then
            echo "ERROR: crumbsConfig.cmake not found in install prefix (${GITHUB_WORKSPACE}/install)";
            echo "full install tree:"; find ${GITHUB_WORKSPACE}/install -maxdepth 5 -type f -print || true;
            exit 1;
          fi
          CRUMBS_DIR=$(dirname "${CRUMBS_CFG}")
          echo "Found crumbs package config at: ${CRUMBS_CFG}";
          echo "crumbs_DIR will be: ${CRUMBS_DIR}"

          echo "--- crumbsConfig.cmake head ---"
          sed -n '1,200p' "${CRUMBS_CFG}" || true
          # Make sure the generated package config actually defines the helper
          if ! grep -q 'include(CMakeFindDependencyMacro)' "${CRUMBS_CFG}"; then
            echo "ERROR: crumbsConfig.cmake missing include(CMakeFindDependencyMacro)";
            exit 1;
          fi
          if ! grep -q 'find_dependency(' "${CRUMBS_CFG}"; then
            echo "WARNING: crumbsConfig.cmake does not contain find_dependency(), this may be okay if crumbs had no package dependencies at build-time.";
          else
            echo "Found find_dependency in crumbsConfig.cmake â€” good.";
          fi
          echo "--- crumbsTargets.cmake (head) ---"
          TARGETS_FILE="${CRUMBS_DIR}/crumbsTargets.cmake"
          [ -f "${TARGETS_FILE}" ] && sed -n '1,200p' "${TARGETS_FILE}" || echo "crumbsTargets.cmake not found in ${CRUMBS_DIR}"

          # If linux_wire config wasn't found, fail early now (we expect linux_wire as dependency)
          if [ -z "${LINUX_WIRE_CFG}" ]; then
            echo "ERROR: linux_wire package config missing; the project depends on linux_wire. Failing early to surface debug info.";
            exit 1;
          fi

          cmake -S examples/native/controller -B build-native -DCRUMBS_BUILD_IN_TREE=OFF -Dcrumbs_DIR=${CRUMBS_DIR} -DCMAKE_PREFIX_PATH="${CMAKE_PREFIX_PATH}" -DCMAKE_BUILD_TYPE=Release
          cmake --build build-native --parallel
          ./build-native/crumbs_native_example

      - name: Restore PlatformIO cache
        uses: actions/cache@v4
        with:
          path: ~/.platformio
          key: ${{ runner.os }}-platformio-v1

      - name: Install PlatformIO CLI
        run: |
          python3 -m pip install -U pip
          python3 -m pip install -U platformio

      - name: Build PlatformIO controller example (Nano)
        run: |
          pushd examples/platformio/controller
          pio run -e nanoatmega328
          popd

      - name: Build PlatformIO peripheral example (Nano)
        run: |
          pushd examples/platformio/peripheral
          pio run -e nanoatmega328
          popd
