name: CI

on:
  push:
    branches: [dev, main]
  pull_request:
    branches: [dev, main]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            git \
            pkg-config \
            libi2c-dev \
            libudev-dev \
            python3-pip

      - name: Build and install linux-wire
        run: |
          git clone --depth=1 https://github.com/FEASTorg/linux-wire.git third_party/linux-wire
          cmake -S third_party/linux-wire -B third_party/linux-wire/build \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/third_party/linux-wire/install
          cmake --build third_party/linux-wire/build --parallel
          cmake --install third_party/linux-wire/build

      - name: Configure CRUMBS
        env:
          CMAKE_PREFIX_PATH: ${{ github.workspace }}/third_party/linux-wire/install
        run: |
          cmake -S . -B build \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCRUMBS_ENABLE_TESTS=ON \
            -DCRUMBS_ENABLE_LINUX_HAL=ON \
            -DCMAKE_PREFIX_PATH="${CMAKE_PREFIX_PATH}"

      - name: Build CRUMBS
        run: cmake --build build --parallel

      - name: Run CRUMBS tests
        run: ctest --test-dir build --output-on-failure

      - name: Install CRUMBS locally for out-of-tree example test
        run: |
          cmake --install build --prefix ${GITHUB_WORKSPACE}/install

      - name: Build native example (out-of-tree) against installed crumbs
        run: |
          cmake -S examples/native/controller -B build-native -DCRUMBS_BUILD_IN_TREE=OFF -DCMAKE_PREFIX_PATH=${GITHUB_WORKSPACE}/install -DCMAKE_BUILD_TYPE=Release
          cmake --build build-native --parallel
          ./build-native/crumbs_native_example

      - name: Install PlatformIO CLI
        run: |
          python3 -m pip install -U pip
          python3 -m pip install -U platformio

      - name: Build PlatformIO controller example (Nano)
        run: |
          pushd examples/platformio/controller
          pio run -e nanoatmega328
          popd

      - name: Build PlatformIO peripheral example (Nano)
        run: |
          pushd examples/platformio/peripheral
          pio run -e nanoatmega328
          popd
