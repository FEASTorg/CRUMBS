# GOAL

The goal is to transform CRUMBS from an Arduino-only C++ library into a clean, portable, cross-platform C99 protocol library with thin HAL layers for Arduino and Linux. The library began as a single monolithic C++ class that handled I2C interactions, message serialization, CRC generation, callbacks, and protocol framing all in one file. This architecture worked but could not be reused on Linux, and could not be cleanly tested or reasoned about. To reach true portability, we have been refactoring it into three independent pieces: core, crc, and hal.

The core layer contains only pure C code and implements the CRUMBS protocol itself: message encoding and decoding, framing rules, CRC checking, callback dispatch, and the logic for sending and receiving messages. This layer knows nothing about Arduino, Linux, Wire, file descriptors, or hardware. It exposes a simple, stable C API that both platforms can use.

The CRC layer provides a platform-independent C implementation of CRC-8. It is generated using pycrc and staged into the repo using scripts. This ensures that both Linux and Arduino use the same CRC logic, without duplicating code or relying on different versions. Arduino additionally gets an optimized progmem version, while Linux uses the raw C99 version.

The HAL layer abstracts I2C access and event dispatch. Arduino’s HAL bridges Wire.beginTransmission, Wire.onReceive, Wire.onRequest, and so on into the C core. Linux’s HAL will bridge the linux-wire low-level interface (open, ioctl, write/read) into the same core API. By keeping HALs minimal and cleanly separated, the protocol stays platform-agnostic.

We started by carving apart the old CRUMBS.cpp so that encoding, decoding, and protocol rules live inside core, while Arduino-specific logic moved into hal/arduino. We then reorganized the directory structure to isolate these responsibilities clearly. Now that the Arduino HAL is nearly complete, the next stage is validating the new C-core API with the existing examples. After Arduino is solid, we will implement the Linux HAL using linux-wire and confirm cross-platform message compatibility, enabling CRUMBS to run identically on Raspberry Pi, Linux SBCs, and Arduino hardware.
